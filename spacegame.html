<!DOCTYPE html>
<html lang='en'>
	<body bgcolor='black' style = 'overflow:hidden'>
		<canvas id='game' tabindex='1' width='640' height='400' style = 'position: absolute; top: 0; left: 0'/>
		<script src = 'spacegame.js'></script>
		<script>

function init_sprites() {
	pcimg = srcimg('MqaLKP2')
	meteorimg = srcimg('ChDuBLO')
	bigmeteorimg = srcimg('tIyQv1V')
	shipimg = srcimg('SbyapXR')
	bigshipimg = srcimg('nzSFj9X')
	armorimg = srcimg('pXRIDRB')
}

function init_constants() {
	playersize = 25
	mobsize = 25
	playerspd = 4
}

function init_entities() {
	particles = []
	stars = []
	player_attacks = []
	enemy_attacks = []
	enemy_mobs = []
  allies = []
}

function init_timers() {
	spawntime = 60
	shottime = 10
	spawner = 0
	shooter = 0
	stargen = 0
}

function init_misc() {
	keypress = [false, false, false, false, false] //w, a, s, d, l
	player = [320, 350] //x, y
	killcount = 0
	highscore = 0
	armor = 3
	paused = false
}

function initialize() {
	canvas = document.getElementById('game')
	ctx = canvas.getContext('2d')

	init_sprites()
	init_constants()
	init_entities()
	init_timers()
	init_misc()

	canvas.addEventListener('keydown', handleKeys, true)
	canvas.addEventListener('keyup', handleKeys, true)

	window.requestAnimFrame(game_loop)
}

function game_loop() {
	if(paused) return

	window.requestAnimFrame(game_loop)

  update_player_pos()
  increment_spawning()
	renderBackground()
	renderEntities()
	renderText()
}

function renderText() {
	ctx.fillStyle = 'white'
	ctx.textAlign = 'left'
	ctx.fillText('kills: ' + killcount, 5, 13)
	ctx.fillText('armor: ', 5, canvas.height - 6)

	ctx.textAlign = 'right'
	ctx.fillText('highscore: ' + highscore, canvas.width - 5, 13)

	ctx.fillStyle = 'grey'
	a = armor
	while(a--)
		dispImg(armorimg, [42 + 15 * a, canvas.height - 10])
}

function renderBackground() {
	ctx.clearRect(0, 0, canvas.width, canvas.height) //clear canvas
}

function renderEntities() {
  ctx.fillStyle = 'white'
	a = stars.length
	while(a--) stars[a].update()

  ctx.fillStyle = 'grey'
	a = particles.length
	while(a--) particles[a].update()

	ctx.fillStyle = 'white'
	a = player_attacks.length
	while(a--) player_attacks[a].update()

	ctx.fillStyle = 'red'
	a = enemy_attacks.length
	while(a--) enemy_attacks[a].update()

	a = enemy_mobs.length
  while(a--) enemy_mobs[a].update()

	dispImg(pcimg, player) //draw player
}

function dispImg(img, pos) {
	center_x = pos[0] - img.width / 2
	center_y = pos[1] - img.height / 2
	ctx.drawImage(img, (center_x|0) + .5, (center_y|0) + .5)
}

function update_player_pos() {
	if (keypress[0]) player[0] -= playerspd
	if (keypress[1]) player[1] -= playerspd
	if (keypress[2]) player[0] += playerspd
	if (keypress[3]) player[1] += playerspd
	if (player[0] > canvas.width - playersize / 2) player[0] = canvas.width - playersize / 2
	if (player[1] > canvas.height - playersize / 2) player[1] = canvas.height - playersize / 2
	if (player[0] < playersize / 2) player[0] = playersize / 2
	if (player[1] < playersize / 2) player[1] = playersize / 2
}

// various spawn timers and mechanics
function increment_spawning() {
	spawner--
	if (spawner <= 0) {
		if (killcount >= 40)
			spawner = spawntime / 4
		else if (killcount >= 15)
			spawner = spawntime / 2
		else
			spawner = spawntime

		x = Math.random() * (canvas.width - mobsize) + mobsize / 2
		y = -mobsize / 2
		x_speed = .6 * Math.random() - .3
		y_speed = 1.5
		shot_offset = 30 + Math.random() * 60

		new Enemy_Ship([x, y], [x_speed, y_speed], shot_offset)
	}

	shooter--
	if (shooter <= 0 && keypress[4]) {
		shooter = shottime
		x = player[0]
		y = player[1]
		side_length = playersize / 2
		shoty = y - side_length
		left = x - side_length
		right = x + side_length

		if (killcount >= 70) {
			a = 5
			while(a--)
				new Player_Shot([x, shoty], a - 2)
		} else if (killcount >= 30) {
			new Player_Shot([left, y], -1)
			new Player_Shot([x, shoty], 0)
			new Player_Shot([right, y], 1)
		} else if (killcount >= 10) {
			new Player_Shot([left, y], 0)
			new Player_Shot([right, y], 0)
		} else {
			new Player_Shot([x, shoty], 0) //x, y, xspd
		}
	}

	if (--stargen <= 0) {
		stargen = 2
		new Star(Math.random() * canvas.width) //x
	}
}

function inc_score() {
  killcount++
  if(killcount > highscore)
  	highscore = killcount
}

function explode(pos, power) {
	var e = power
	while(e--) {
		var angle = Math.random() * Math.PI * 2
		var blast = Math.random() * Math.sqrt(power) / 4
		var xspeed = Math.cos(angle) * blast
		var yspeed = Math.sin(angle) * blast
		new Particle([pos[0], pos[1]], [xspeed, yspeed])
	}
}

function hitplayer() {
	explode([27 + 15 * armor, canvas.height - 10], 50)
	if (--armor == 0) restart()
}

function restart() {
  a = 0
	explode(player, 1000)
  player_attacks = []
  enemy_attacks = []
  enemy_mobs = []
  player = [320, 350]
  killcount = 0
  armor = 3
}

function collision(entity1, entity2, dist) {
	x1 = entity1[0]
	y1 = entity1[1]
	x2 = entity2[0]
	y2 = entity2[1]
	return ( Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2) ) < Math.pow(dist, 2)
}

function handleKeys(event) { //user key input
	var a = -1
	switch(event.keyCode) {
		case 37:
		case 65: a = 0; break //a
		case 38:
		case 87: a = 1; break //w
		case 39:
		case 68: a = 2; break //d
		case 40:
		case 83: a = 3; break //s
		case 32:
		case 76: a = 4; break //l
	}
	var down = event.type == 'keydown'
	if(a >= 0) {
		keypress[a] = down ? true : false
	    event.preventDefault()
	    event.stopPropagation()
	}

	if(event.keyCode == 80 && down) toggle_pause() //p

    event.preventDefault();
    event.stopPropagation();
}

function toggle_pause() {
	paused = !paused
	if(paused) {
		ctx.fillStyle = 'white'
		ctx.fillText('-paused-', canvas.width / 2 + 20, canvas.height / 2 + 5)
	} else window.requestAnimFrame(game_loop)
}

function srcimg(src) { //get images easier
	img = document.createElement('img')
	img.src = 'http://i.imgur.com/' + src + '.png'
	return img
}

window.requestAnimFrame = (function() { //render cycle
	return window.requestAnimationFrame || 
	window.webkitRequestAnimationFrame || 
	window.mozRequestAnimationFrame || 
	window.oRequestAnimationFrame || 
	window.msRequestAnimationFrame || 
	function(callback, element){
		window.setTimeout(callback, 1000 / 60)
	}
})()

initialize()

		</script>
	</body>
</html>